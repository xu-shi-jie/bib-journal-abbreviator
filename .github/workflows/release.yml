name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential g++ musl musl-dev musl-tools
        
    - name: Build C++ application
      run: |
        make all
        
    - name: Test build
      run: |
        ls -la refabbr
        ./refabbr --help || echo "Build successful"
        
    - name: Prepare release assets
      run: |
        mkdir -p release
        cp refabbr release/
        cp README.md release/
        tar -czf bib-journal-abbreviator-linux-x64.tar.gz -C release .
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        release_name: BibTeX Journal Abbreviator ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## Changes in ${{ steps.get_version.outputs.VERSION }}
          
          ### 🚀 Features
          - Automatic build and release for Ubuntu/Linux x64
          
          ### 📦 Download
          - Download `bib-journal-abbreviator-linux-x64.tar.gz` for Linux x64 systems
          - Extract and run `./refabbr` or use the Python version `python3 main.v1.py`
          
          ### 📝 Usage
          ```bash
          # Extract the archive
          tar -xzf bib-journal-abbreviator-linux-x64.tar.gz
          
          # Run the C++ version
          ./refabbr ref.bib
          ```
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./bib-journal-abbreviator-linux-x64.tar.gz
        asset_name: bib-journal-abbreviator-linux-x64.tar.gz
        asset_content_type: application/gzip
